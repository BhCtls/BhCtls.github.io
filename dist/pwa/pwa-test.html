<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA æµ‹è¯• - Tounet</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .test-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .test-item:last-child {
            border-bottom: none;
        }
        
        .status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .status.error {
            background: #ffebee;
            color: #c62828;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            background: #667eea;
            color: white;
            cursor: pointer;
            margin: 5px;
        }
        
        .btn:hover {
            background: #5a6fd8;
        }
        
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 15px 0;
        }
        
        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #667eea;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <a href="../index.html" class="back-link">â† è¿”å›ä¸»é¡µ</a>
    
    <h1>ğŸ”§ PWA åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-container">
        <h2>åŸºç¡€ PWA åŠŸèƒ½æ£€æµ‹</h2>
        <div class="test-item">
            <span>Service Worker æ”¯æŒ</span>
            <span id="sw-support" class="status">æ£€æµ‹ä¸­...</span>
        </div>
        <div class="test-item">
            <span>Service Worker æ³¨å†ŒçŠ¶æ€</span>
            <span id="sw-status" class="status">æ£€æµ‹ä¸­...</span>
        </div>
        <div class="test-item">
            <span>Manifest æ–‡ä»¶</span>
            <span id="manifest-status" class="status">æ£€æµ‹ä¸­...</span>
        </div>
        <div class="test-item">
            <span>ç¦»çº¿æ”¯æŒ</span>
            <span id="offline-status" class="status">æ£€æµ‹ä¸­...</span>
        </div>
        <div class="test-item">
            <span>å®‰è£…æç¤ºæ”¯æŒ</span>
            <span id="install-status" class="status">æ£€æµ‹ä¸­...</span>
        </div>
        <div class="test-item">
            <span>é€šçŸ¥æƒé™</span>
            <span id="notification-status" class="status">æ£€æµ‹ä¸­...</span>
        </div>
    </div>
    
    <div class="test-container">
        <h2>åŠŸèƒ½æµ‹è¯•</h2>
        <button class="btn" onclick="testNotification()">æµ‹è¯•é€šçŸ¥</button>
        <button class="btn" onclick="testCacheStatus()">æ£€æŸ¥ç¼“å­˜çŠ¶æ€</button>
        <button class="btn" onclick="testOfflineMode()">æ¨¡æ‹Ÿç¦»çº¿æ¨¡å¼</button>
        <button class="btn" onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
        <button class="btn" onclick="exportConfig()">å¯¼å‡ºé…ç½®</button>
    </div>
    
    <div class="test-container">
        <h2>åº”ç”¨ä¿¡æ¯</h2>
        <div id="app-info"></div>
    </div>
    
    <div class="info-box">
        <h3>ğŸ“± å¦‚ä½•å®‰è£… PWA</h3>
        <p><strong>Chrome/Edge (æ¡Œé¢):</strong> åœ°å€æ å³ä¾§çš„å®‰è£…å›¾æ ‡</p>
        <p><strong>Chrome (ç§»åŠ¨):</strong> èœå• â†’ "æ·»åŠ åˆ°ä¸»å±å¹•"</p>
        <p><strong>Safari (iOS):</strong> åˆ†äº«æŒ‰é’® â†’ "æ·»åŠ åˆ°ä¸»å±å¹•"</p>
        <p><strong>Firefox:</strong> åœ°å€æ å³ä¾§çš„å®‰è£…å›¾æ ‡</p>
    </div>

    <script>
        // æ£€æµ‹ PWA åŠŸèƒ½
        async function checkPWAFeatures() {
            // Service Worker æ”¯æŒ
            const swSupport = 'serviceWorker' in navigator;
            updateStatus('sw-support', swSupport);
            
            // Service Worker çŠ¶æ€
            if (swSupport) {
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    updateStatus('sw-status', !!registration);
                } catch (e) {
                    updateStatus('sw-status', false);
                }
            } else {
                updateStatus('sw-status', false);
            }
            
            // Manifest æ£€æµ‹
            const manifestLink = document.querySelector('link[rel="manifest"]');
            updateStatus('manifest-status', !!manifestLink);
            
            // ç¦»çº¿æ”¯æŒæ£€æµ‹ï¼ˆé€šè¿‡æ£€æŸ¥ç¼“å­˜ï¼‰
            try {
                const cacheNames = await caches.keys();
                updateStatus('offline-status', cacheNames.length > 0);
            } catch (e) {
                updateStatus('offline-status', false);
            }
            
            // å®‰è£…æç¤ºæ”¯æŒ
            updateStatus('install-status', 'BeforeInstallPromptEvent' in window || 'onbeforeinstallprompt' in window);
            
            // é€šçŸ¥æƒé™
            if ('Notification' in window) {
                updateStatus('notification-status', Notification.permission !== 'denied');
            } else {
                updateStatus('notification-status', false);
            }
        }
        
        function updateStatus(id, success) {
            const element = document.getElementById(id);
            element.textContent = success ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ';
            element.className = `status ${success ? 'success' : 'error'}`;
        }
        
        // æµ‹è¯•é€šçŸ¥
        async function testNotification() {
            if ('Notification' in window) {
                let permission = Notification.permission;
                
                if (permission === 'default') {
                    permission = await Notification.requestPermission();
                }
                
                if (permission === 'granted') {
                    new Notification('PWA æµ‹è¯•é€šçŸ¥', {
                        body: 'é€šçŸ¥åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼',
                        icon: '/icon.png',
                        badge: '/icon.png'
                    });
                } else {
                    alert('é€šçŸ¥æƒé™è¢«æ‹’ç»');
                }
            } else {
                alert('æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥åŠŸèƒ½');
            }
        }
        
        // æ£€æŸ¥ç¼“å­˜çŠ¶æ€
        async function testCacheStatus() {
            try {
                const cacheNames = await caches.keys();
                const cacheInfo = [];
                
                for (const cacheName of cacheNames) {
                    const cache = await caches.open(cacheName);
                    const keys = await cache.keys();
                    cacheInfo.push(`${cacheName}: ${keys.length} ä¸ªæ–‡ä»¶`);
                }
                
                alert(`ç¼“å­˜çŠ¶æ€:\n${cacheInfo.join('\n')}`);
            } catch (e) {
                alert('æ— æ³•è®¿é—®ç¼“å­˜: ' + e.message);
            }
        }
        
        // æ¨¡æ‹Ÿç¦»çº¿æ¨¡å¼
        function testOfflineMode() {
            alert('è¯·æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œåœ¨ Network é€‰é¡¹å¡ä¸­é€‰æ‹© "Offline" æ¥æµ‹è¯•ç¦»çº¿åŠŸèƒ½');
        }
        
        // æ¸…é™¤æ‰€æœ‰æ•°æ®
        async function clearAllData() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰åº”ç”¨æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤ç¼“å­˜ã€æœ¬åœ°å­˜å‚¨ç­‰ã€‚')) {
                try {
                    // æ¸…é™¤ç¼“å­˜
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                    
                    // æ¸…é™¤å­˜å‚¨
                    localStorage.clear();
                    sessionStorage.clear();
                    
                    alert('æ‰€æœ‰æ•°æ®å·²æ¸…é™¤ï¼Œé¡µé¢å°†é‡æ–°åŠ è½½');
                    window.location.reload();
                } catch (e) {
                    alert('æ¸…é™¤æ•°æ®å¤±è´¥: ' + e.message);
                }
            }
        }
        
        // å¯¼å‡ºé…ç½®
        function exportConfig() {
            if (window.pwaTools) {
                window.pwaTools.exportConfig();
            } else {
                alert('PWA å·¥å…·æœªåŠ è½½');
            }
        }
        
        // æ˜¾ç¤ºåº”ç”¨ä¿¡æ¯
        function showAppInfo() {
            const info = {
                userAgent: navigator.userAgent,
                language: navigator.language,
                online: navigator.onLine,
                cookieEnabled: navigator.cookieEnabled,
                platform: navigator.platform,
                screen: `${screen.width}x${screen.height}`,
                viewport: `${window.innerWidth}x${window.innerHeight}`,
                pixelRatio: window.devicePixelRatio
            };
            
            const infoHtml = Object.entries(info)
                .map(([key, value]) => `<strong>${key}:</strong> ${value}`)
                .join('<br>');
            
            document.getElementById('app-info').innerHTML = infoHtml;
        }
        
        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œæ£€æµ‹
        document.addEventListener('DOMContentLoaded', () => {
            checkPWAFeatures();
            showAppInfo();
        });
    </script>
</body>
</html>
