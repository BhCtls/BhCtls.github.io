<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>卡片属性编辑器</title>
    <style>
        .container {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 20px;
            padding: 8px 20px;
        }
        @media (max-height: 800px) {
            .container {
                grid-template-columns: 280px 0.7fr;
            }
        }
        /* maxheight适配平板横屏，maxwidth适配手机，minwidth适配超宽电脑 */
        @media (max-width: 700px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            .controls {
                position: sticky;
                top: 0;
            }
        }
        @media (min-width: 1100px) {
            .container {
          max-width: 1100px;
          margin-left: auto;
          margin-right: auto;
            }
            .controls {
          position: relative;
            }
        }
        .preview {
            position: sticky;
            top: 20px;
        }
        .controls {
            display: grid;
            gap: 10px;
            height: auto;
        }

        .control-group {
            padding: 18px 18px 12px 18px;
            border: 1.5px solid #866be6;
            border-radius: 10px;
            background: #d6ddee;
            box-shadow: 0 2px 8px 0 #afbbff;
        }
        .control-group h2 {
            font-size: 1.15em;
            color: #3a5a8c;
            margin-bottom: 8px;
            margin-top: 0;
            letter-spacing: 1px;
        }
        label {
            display: block;
            margin: 3px 0 1px 0; /* 更密集 */
            color: #2d3a4a;
            font-size: 0.98em;
            font-weight: 500;
        }
        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 3px 8px; /* 上下间距更小 */
            border: 1px solid #c3d0e0;
            border-radius: 5px;
            background: #f1f8ff;
            font-size: 1em;
            margin-top: 1px;
            margin-bottom: 3px;
            transition: border 0.2s;
            box-sizing: border-box;
        }
        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            border: 1.5px solid #6fa1e6;
            outline: none;
            background: #f1f8ff;
        }
        button {
            background: linear-gradient(90deg, #6fa1e6 0%, #4e7cc7 100%);
            color: #f1f8ff;
            border: none;
            border-radius: 5px;
            padding: 5px 12px;
            margin-right: 6px;
            font-size: 0.98em;
            cursor: pointer;
            transition: background 0.2s;
            box-shadow: 0 1px 3px #f1f8ff;
        }
        button:hover {
            background: linear-gradient(90deg, #4e7cc7 0%, #6fa1e6 100%);
        }
        /* 美化复选框 */
        input[type="checkbox"] {
            width: 22px;
            height: 22px;
            accent-color: #6fa1e6;
            vertical-align: middle;
            margin-right: 4px;
            cursor: pointer;
            border-radius: 5px;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            user-select: none;
            font-size: 1.08em;
        }
        .offset-control {
            display: flex;
            flex-direction: column;
            gap: 2px;
            margin-bottom: 6px;
        }
        .offset-label-row {
            margin-bottom: 2px;
            font-weight: 500;
            color: #2d3a4a;
        }
        .offset-slider-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .offset-value {
            width: 55px;
            text-align: center;
            border: 1px solid #c3d0e0;
            border-radius: 5px;
            padding: 4px 0;
            background: #f7fafd;
        }
        input[type="range"] {
            flex: 1;
            accent-color: #6fa1e6;
            margin: 0 5px;
        }
        small {
            color: #888;
            margin-left: 4px;
        }
        /* Token验证相关样式 */
        .auth-controls {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        .auth-controls input {
            flex: 1;
        }
        .auth-controls button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            background: #007acc;
            color: white;
        }
        .auth-controls button:hover {
            background: #005a9e;
        }
        .auth-controls button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .auth-status {
            margin-top: 8px;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
        }
        .auth-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .auth-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        /* 禁用状态样式 */
        input:disabled, button:disabled {
            background: #f5f5f5 !important;
            color: #999 !important;
            cursor: not-allowed !important;
        }
    </style>
    <!-- html2canvas库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js "></script>
</head>
<body>
<div class="container">
    <div class="controls">
        <div class="control-group">
            <div class="auth-section">
              <label for="token-input">验证您的tounetNtoken</label>
              <div class="auth-controls">
                <input id="token-input" type="password" placeholder="输入Ntoken">
                <button id="verify-btn">验证</button>
              </div>
              <div id="auth-status" class="auth-status" style="display: none;"></div>
            </div>
            <h2>卡图数据</h2>
            <label>图片(或远程图床)地址：
                <input type="text" id="chara" value="/../custom/assets_mu3/UI_Card_Chara_199001_P.png">
                <button type="button" id="uploadLocalBtn">本地图片</button>
                <button type="button" id="toggleImgSourceBtn">切换为本地/远程</button>
                <input type="file" id="localImgInput" accept="image/png, image/jpeg, image/jpg" style="display:none;">
            </label>
            
            <div class="offset-control">
              <label class="offset-label-row">左右偏移:</label>
              <div class="offset-slider-row">
                <input type="range" id="offsetX" min="-100" max="100" value="0" style="flex: 1; margin-right: 1px;">
                <input type="number" id="offsetXValue" class="offset-value" value="0" min="-100" max="100" style="width: 55px; flex: none; margin-left: 2px;">
              </div>
            </div>

            <h2 style="display: inline-block; margin-right: 10px;">主要属性</h2>
            <label style="display: inline-block;">
                <input type="checkbox" id="toggleMainAttributes">
            </label>
            <label>属性图片:
                <select id="attribute">
                    <option value="/../assets/images/ui/UI_Card_Attribute_00_Red.webp">Fire</option>
                    <option value="/../assets/images/ui/UI_Card_Attribute_01_Bule.webp" selected>Aqua</option>
                    <option value="/../assets/images/ui/UI_Card_Attribute_02_Green.webp">Leaf</option>
                </select>
            </label>
            <label>名称: <input type="text" id="name" value="三角 葵"></label>
            <label>昵称: <input type="text" id="nick" value="Individual on Parade!"></label>
            <label>稀有度:
                <select id="rarity">
                    <option value="/../assets/images/ui/UI_Card_Rare_03_SSR.webp">SSR</option>
                    <option value="/../assets/images/ui/UI_Card_Rare_05_SRPlus.webp">SR+</option>
                    <option value="/../assets/images/ui/UI_Card_Rare_02_SR.webp">SR</option>
                </select>
            </label>
            <label>年级:
                <select id="grade">
                    <option value="">无</option>
                    <option value="/../assets/images/ui/UI_Card_Grade_00001.webp">高中一年级</option>
                    <option value="/../assets/images/ui/UI_Card_Grade_00002.webp" selected>高中二年级</option>
                    <option value="/../assets/images/ui/UI_Card_Grade_00003.webp">高中三年级</option>
                    <option value="/../assets/images/ui/UI_Card_Grade_00005.webp">初中二年级</option>
                </select>
            </label>
            <h2 style="display: inline-block; margin-right: 10px;">其他属性</h2>
            <label style="display: inline-block;">
                <input type="checkbox" id="toggleSubAttributes">
            </label>
            <label>序列号: <input type="text" id="serial" value="11010119530615199001"></label>
            <label>版本号: <input type="text" id="version" value="[O.N.G.E.K.I.]2.05-0001"></label>
            <label>技能背景:
                <select id="skill">
                    <option value="/../assets/images/ui/UI_Card_Skill_00_Attack.webp">Attack</option>
                    <option value="/../assets/images/ui/UI_Card_Skill_02_Guard.webp">Guard</option>
                    <option value="/../assets/images/ui/UI_Card_Skill_03_Boost.webp">Boost</option>
                </select>
            </label>
            <label>星级:
                <select id="stars">
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5" selected>5</option>
                </select>
            </label>
            <label>攻击力: <input type="number" id="atk" value="331" min="0" max="999"></label>
          <button id="downloadBtn" >下载卡片</button><small>图源需允许CORS</small>
        </div>
    </div>

    <div class="preview">
        <div id="livePreview"></div>
    </div>
</div>

<script>
    // Token验证相关变量
    const tokenInput = document.getElementById('token-input');
    const verifyBtn = document.getElementById('verify-btn');
    const authStatus = document.getElementById('auth-status');
    let isAuthenticated = false;

    // 原始模板
    const template = `
        <!DOCTYPE html>
<!-- saved from url=(0047)https://portal.naominet.live/ongeki/card?page=4  -->
<html data-critters-container="" data-bs-theme="dark">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

  <meta name="robots" content="noindex">
  <title>CardPreview | Powered by RinNET</title>
  <!--<base href="/">-->
  <base href=".">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link href="https://portal.naominet.live/assets/turtle.svg " rel="icon" type="image/x-icon">
  <link href="https://portal.naominet.live/manifest.webmanifest " rel="manifest">
  <meta name="theme-color" content="#2a2f33">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <style>
    :root {
      --bs-blue: #0d6efd;
      --bs-indigo: #6610f2;
      --bs-purple: #6f42c1;
      --bs-pink: #d63384;
      --bs-red: #dc3545;
      --bs-orange: #fd7e14;
      --bs-yellow: #ffc107;
      --bs-green: #198754;
      --bs-teal: #20c997;
      --bs-cyan: #0dcaf0;
      --bs-black: #000;
      --bs-white: #fff;
      --bs-gray: #6c757d;
      --bs-gray-dark: #343a40;
      --bs-gray-100: #f8f9fa;
      --bs-gray-200: #e9ecef;
      --bs-gray-300: #dee2e6;
      --bs-gray-400: #ced4da;
      --bs-gray-500: #adb5bd;
      --bs-gray-600: #6c757d;
      --bs-gray-700: #495057;
      --bs-gray-800: #343a40;
      --bs-gray-900: #212529;
      --bs-primary: #0d6efd;
      --bs-secondary: #6c757d;
      --bs-success: #198754;
      --bs-info: #0dcaf0;
      --bs-warning: #ffc107;
      --bs-danger: #dc3545;
      --bs-light: #f8f9fa;
      --bs-dark: #212529;
      --bs-primary-rgb: 13, 110, 253;
      --bs-secondary-rgb: 108, 117, 125;
      --bs-success-rgb: 25, 135, 84;
      --bs-info-rgb: 13, 202, 240;
      --bs-warning-rgb: 255, 193, 7;
      --bs-danger-rgb: 220, 53, 69;
      --bs-light-rgb: 248, 249, 250;
      --bs-dark-rgb: 33, 37, 41;
      --bs-primary-text-emphasis: #052c65;
      --bs-secondary-text-emphasis: #2b2f32;
      --bs-success-text-emphasis: #0a3622;
      --bs-info-text-emphasis: #055160;
      --bs-warning-text-emphasis: #664d03;
      --bs-danger-text-emphasis: #58151c;
      --bs-light-text-emphasis: #495057;
      --bs-dark-text-emphasis: #495057;
      --bs-primary-bg-subtle: #cfe2ff;
      --bs-secondary-bg-subtle: #e2e3e5;
      --bs-success-bg-subtle: #d1e7dd;
      --bs-info-bg-subtle: #cff4fc;
      --bs-warning-bg-subtle: #fff3cd;
      --bs-danger-bg-subtle: #f8d7da;
      --bs-light-bg-subtle: #fcfcfd;
      --bs-dark-bg-subtle: #ced4da;
      --bs-primary-border-subtle: #9ec5fe;
      --bs-secondary-border-subtle: #c4c8cb;
      --bs-success-border-subtle: #a3cfbb;
      --bs-info-border-subtle: #9eeaf9;
      --bs-warning-border-subtle: #ffe69c;
      --bs-danger-border-subtle: #f1aeb5;
      --bs-light-border-subtle: #e9ecef;
      --bs-dark-border-subtle: #adb5bd;
      --bs-white-rgb: 255, 255, 255;
      --bs-black-rgb: 0, 0, 0;
      --bs-font-sans-serif: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", "Noto Sans", "Liberation Sans", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      --bs-font-monospace: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --bs-gradient: linear-gradient(180deg, rgba(255, 255, 255, .15), rgba(255, 255, 255, 0));
      --bs-body-font-family: var(--bs-font-sans-serif);
      --bs-body-font-size: 1rem;
      --bs-body-font-weight: 400;
      --bs-body-line-height: 1.5;
      --bs-body-color: #212529;
      --bs-body-color-rgb: 33, 37, 41;
      --bs-body-bg: #fff;
      --bs-body-bg-rgb: 255, 255, 255;
      --bs-emphasis-color: #000;
      --bs-emphasis-color-rgb: 0, 0, 0;
      --bs-secondary-color: rgba(33, 37, 41, .75);
      --bs-secondary-color-rgb: 33, 37, 41;
      --bs-secondary-bg: #e9ecef;
      --bs-secondary-bg-rgb: 233, 236, 239;
      --bs-tertiary-color: rgba(33, 37, 41, .5);
      --bs-tertiary-color-rgb: 33, 37, 41;
      --bs-tertiary-bg: #f8f9fa;
      --bs-tertiary-bg-rgb: 248, 249, 250;
      --bs-heading-color: inherit;
      --bs-link-color: #0d6efd;
      --bs-link-color-rgb: 13, 110, 253;
      --bs-link-decoration: underline;
      --bs-link-hover-color: #0a58ca;
      --bs-link-hover-color-rgb: 10, 88, 202;
      --bs-code-color: #d63384;
      --bs-highlight-color: #212529;
      --bs-highlight-bg: #fff3cd;
      --bs-border-width: 1px;
      --bs-border-style: solid;
      --bs-border-color: #dee2e6;
      --bs-border-color-translucent: rgba(0, 0, 0, .175);
      --bs-border-radius: .375rem;
      --bs-border-radius-sm: .25rem;
      --bs-border-radius-lg: .5rem;
      --bs-border-radius-xl: 1rem;
      --bs-border-radius-xxl: 2rem;
      --bs-border-radius-2xl: var(--bs-border-radius-xxl);
      --bs-border-radius-pill: 50rem;
      --bs-box-shadow: 0 .5rem 1rem rgba(0, 0, 0, .15);
      --bs-box-shadow-sm: 0 .125rem .25rem rgba(0, 0, 0, .075);
      --bs-box-shadow-lg: 0 1rem 3rem rgba(0, 0, 0, .175);
      --bs-box-shadow-inset: inset 0 1px 2px rgba(0, 0, 0, .075);
      --bs-focus-ring-width: .25rem;
      --bs-focus-ring-opacity: .25;
      --bs-focus-ring-color: rgba(13, 110, 253, .25);
      --bs-form-valid-color: #198754;
      --bs-form-valid-border-color: #198754;
      --bs-form-invalid-color: #dc3545;
      --bs-form-invalid-border-color: #dc3545
    }

    *,
    :after,
    :before {
      box-sizing: border-box
    }

    @media (prefers-reduced-motion:no-preference) {
      :root {
        scroll-behavior: smooth
      }
    }

    body {
      margin: 0;
      font-family: var(--bs-body-font-family);
      font-size: var(--bs-body-font-size);
      font-weight: var(--bs-body-font-weight);
      line-height: var(--bs-body-line-height);
      color: var(--bs-body-color);
      text-align: var(--bs-body-text-align);
      background-color: var(--bs-body-bg);
      -webkit-text-size-adjust: 100%;
      -webkit-tap-highlight-color: transparent
    }

    :root {
      --bs-breakpoint-xs: 0;
      --bs-breakpoint-sm: 576px;
      --bs-breakpoint-md: 768px;
      --bs-breakpoint-lg: 992px;
      --bs-breakpoint-xl: 1200px;
      --bs-breakpoint-xxl: 1400px
    }

    :root {
      --bs-breakpoint-xs: 0;
      --bs-breakpoint-sm: 576px;
      --bs-breakpoint-md: 768px;
      --bs-breakpoint-lg: 992px;
      --bs-breakpoint-xl: 1200px;
      --bs-breakpoint-xxl: 1400px
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      font-family: var(--bs-body-font-family)
    }
  </style>
  <link rel="stylesheet" href="styles.css" media="all" onload="this.media='all'">
  <noscript>
    <link rel="stylesheet" href="styles.css">
  </noscript>
  <style>
    .app-container[p1] {
      display: flex;
      flex-direction: column;
      min-height: 80vh
    }

    .navbar-brand[p1] {
      -webkit-user-select: none;
      user-select: none
    }

    .app-navbar[p1] {
      -webkit-backdrop-filter: blur(25px) brightness(100%) saturate(160%);
      backdrop-filter: blur(25px) brightness(100%) saturate(160%);
      background: rgba(var(--bs-tertiary-bg-rgb), .9) !important;
      height: 3.6rem;
      z-index: 999
    }

    .content[p1] {
      background-origin: content-box;
      height: auto;
      overflow-y: visible;
      width: 92%;
      max-width: 1280px;
      box-sizing: border-box;
      padding: 30px;
      margin: auto
    }

    .content[p1] .padding[p1] {
      padding-top: 4px
    }

    .dark[p1] {
      background-color: #202124
    }

    .hide[p1] {
      display: none
    }

    .link-btn[p1] {
      padding: .3rem .5rem;
      color: var(--bs-body-color);
      text-decoration: none !important;
      cursor: pointer;
      transition: all .1s ease 0s
    }

    .link-btn[p1]:hover,
    .link-btn.active[p1] {
      color: #fff !important;
      background-color: var(--bs-primary)
    }

    .link-btn.active[p1] {
      font-weight: 700
    }

    .user-popover[p1] {
      min-width: 10rem
    }

    .link-btn-danger[p1] {
      color: var(--bs-danger)
    }

    .link-btn-danger[p1]:hover,
    .link-btn-danger.active[p1] {
      color: #fff;
      background-color: var(--bs-danger)
    }

    .sidebar[p1] {
      grid-area: sidebar;
      min-width: 14rem;
      top: 4.1rem
    }

    @media (min-width: 992px) {
      .sidebar[p1] {
        margin-top: 4.1rem;
        max-height: calc(100vh - 4.6rem)
      }
    }

    @font-face {
      font-family: SEGA_Humming;
      src: url(/../assets/fonts/SEGA_Humming.ttf) format("truetype")
    }

    .progress[p1] {
      border-radius: 0;
      height: 2px
    }

    .progress-bar.indeterminate-front[p1] {
      position: relative;
      animation: p1_progress-indeterminate 3s ease-in-out infinite;
      animation-delay: -.5s !important
    }

    .progress-bar.indeterminate-back[p1] {
      position: relative;
      animation: p1_progress-indeterminate 3s ease-out infinite;
      animation-delay: 1s !important
    }

    @keyframes p1_progress-indeterminate {
      0% {
        left: -25%;
        width: 25%
      }

      to {
        left: 150%;
        width: 150%
      }
    }

    .footer[p1] {
      width: 100%;
      color: var(--bs-body-color);
      font-size: small
    }

    .footer a {
      color: var(--bs-body-color);
      text-decoration: none
    }

    .footer a:hover {
      color: var(--bs-body-color);
      cursor: pointer;
      text-decoration: underline
    }

    @media (max-width: 991.98px) {
      .sidebar[p1] {
        z-index: 1040
      }
    }
  </style>
  <style>
    [_nghost-ng-c948354662] {
      display: inline-block;
      width: var(--ng-icon__size);
      height: var(--ng-icon__size)
    }
  </style>
  <style>
    .btn-top[p0] {
      width: 5em
    }

    .cards-col[p0] {
      width: 100%;
      perspective: 1500px;
      transform-style: preserve-3d;
      --rotator-transition: all .6s ease-out;
      --rotator-global-rotate-y: 0deg;
      --rotator-rotate-x: 0deg;
      --rotator-rotate-y: 0deg;
      --pseudo-opacity: 0;
      --pseudo-left: 50%;
      --pseudo-top: 50%;
      --holo-sheet-bottom: none;
      --holo-sheet-middle: none;
      --holo-sheet-top: none
    }

    .card-picking[p0] {
      --rotator-global-rotate-y: 360deg
    }

    .cards-col[p0] .card-rotator[p0] {
      width: 100%;
      height: 100%;
      transition: var(--rotator-transition);
      -webkit-appearance: none;
      appearance: none;
      will-change: transform;
      transform: rotateX(var(--rotator-rotate-x)) rotateY(calc(var(--rotator-global-rotate-y) + var(--rotator-rotate-y)));
      transform-style: preserve-3d;
      border-radius: 3%;
      box-shadow: 0 0 10px -5px gray, 0 0 15px -5px gray
    }

    .cards-col[p0] .card-holo[p0]:after {
      --space: 4%;
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 100%;
      background-position: center center, calc(20% + var(--pseudo-left) * .6) calc(20% + var(--pseudo-top) * .6), center center;
      background-size: cover, 400% 900%, cover;
      will-change: background-image;
      background-image: var(--holo-sheet-top), repeating-linear-gradient(75deg, hsl(53, 65%, 60%) calc(var(--space) * 1), hsl(93, 56%, 50%) calc(var(--space) * 2), hsl(176, 54%, 49%) calc(var(--space) * 3), hsl(228, 59%, 55%) calc(var(--space) * 4), hsl(283, 60%, 55%) calc(var(--space) * 5), hsl(326, 59%, 51%) calc(var(--space) * 6), hsl(326, 59%, 51%) calc(var(--space) * 7), hsl(283, 60%, 55%) calc(var(--space) * 8), hsl(228, 59%, 55%) calc(var(--space) * 9), hsl(176, 54%, 49%) calc(var(--space) * 10), hsl(93, 56%, 50%) calc(var(--space) * 11), hsl(53, 65%, 60%) calc(var(--space) * 12));
      background-blend-mode: multiply, multiply;
      filter: brightness(1.25) contrast(1.75) saturate(.8);
      mix-blend-mode: multiply;
      transition: var(--rotator-transition)
    }

    .cards-col[p0] .card-holo[p0]:before {
      --space: 4%;
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 100%;
      background-position: center center, calc(15% + var(--pseudo-left) * .7) calc(15% + var(--pseudo-top) * .7), center center;
      background-size: cover, 400% 900%, cover;
      will-change: background-image;
      background-image: var(--holo-sheet-middle), repeating-linear-gradient(75deg, hsl(53, 65%, 60%) calc(var(--space) * 1), hsl(93, 56%, 50%) calc(var(--space) * 2), hsl(176, 54%, 49%) calc(var(--space) * 3), hsl(228, 59%, 55%) calc(var(--space) * 4), hsl(283, 60%, 55%) calc(var(--space) * 5), hsl(326, 59%, 51%) calc(var(--space) * 6), hsl(326, 59%, 51%) calc(var(--space) * 7), hsl(283, 60%, 55%) calc(var(--space) * 8), hsl(228, 59%, 55%) calc(var(--space) * 9), hsl(176, 54%, 49%) calc(var(--space) * 10), hsl(93, 56%, 50%) calc(var(--space) * 11), hsl(53, 65%, 60%) calc(var(--space) * 12));
      background-blend-mode: lighten, multiply;
      filter: brightness(1.25) contrast(1.75) saturate(.8);
      mix-blend-mode: overlay;
      transition: var(--rotator-transition)
    }

    .cards-col[p0] .card-holo[p0] {
      --space: 4%;
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 100%;
      background-position: center center, calc(10% + var(--pseudo-left) * .8) calc(10% + var(--pseudo-top) * .8), center center;
      background-size: cover, 400% 900%, cover;
      will-change: background-image;
      background-image: var(--holo-sheet-bottom), repeating-linear-gradient(75deg, hsl(53, 65%, 60%) calc(var(--space) * 1), hsl(93, 56%, 50%) calc(var(--space) * 2), hsl(176, 54%, 49%) calc(var(--space) * 3), hsl(228, 59%, 55%) calc(var(--space) * 4), hsl(283, 60%, 55%) calc(var(--space) * 5), hsl(326, 59%, 51%) calc(var(--space) * 6), hsl(326, 59%, 51%) calc(var(--space) * 7), hsl(283, 60%, 55%) calc(var(--space) * 8), hsl(228, 59%, 55%) calc(var(--space) * 9), hsl(176, 54%, 49%) calc(var(--space) * 10), hsl(93, 56%, 50%) calc(var(--space) * 11), hsl(53, 65%, 60%) calc(var(--space) * 12));
      background-blend-mode: color-burn, multiply;
      filter: brightness(1.25) contrast(1.75) saturate(.8);
      mix-blend-mode: color-dodge;
      transition: var(--rotator-transition);
      -webkit-mask-size: cover;
      mask-composite: intersect, subtract;
      -webkit-mask-size: cover;
      mask-size: cover;
      mask-composite: intersect, subtract;
    }

    .card-holo-bg[p0] {
      background-color: gray;
      position: absolute;
      width: 100%;
      height: 100%;
      -webkit-mask-size: cover;
      -webkit-mask-size: cover;
      mask-size: cover;
      mask-mode: alpha, alpha;
      -webkit-mask-composite: source-in, source-out;
      mask-composite: source-in, source-out;
    }

    .card-frame[p0],
    .card-chara[p0] {
      position: absolute;
      background-size: cover;
      width: 100%;
      height: 100%
    }

    .card-holo-frame-bg[p0] {
      background-color: gray;
      position: absolute;
      width: 100%;
      height: 100%;
      mask-composite: intersect;
      -webkit-mask-composite: source-in;
      -webkit-mask-size: cover;
      mask-size: cover;
      mask-mode: alpha
    }

    .card-highlight[p0] {
      position: absolute;
      transform: translate(-50%, -50%);
      left: var(--pseudo-left);
      top: var(--pseudo-top);
      width: 250%;
      height: 250%;
      background: radial-gradient(farthest-corner circle at 50% 50%, hsl(280, 100%, 96%) 5%, hsl(0, 0%, 10%) 60%);
      pointer-events: none;
      transition: var(--rotator-transition);
      opacity: var(--pseudo-opacity);
      filter: brightness(.75) contrast(2) saturate(2);
      mix-blend-mode: soft-light
    }

    .card-container[p0] {
      aspect-ratio: .730038022813688;
      width: 100%;
      top: 0;
      left: 0;
      border-radius: 3%;
      overflow: hidden;
      position: relative;
      background-size: cover;
      container: card-container / inline-size
    }

    .card-attribute[p0] {
      width: 17%;
      top: 8%;
      left: 12%;
      transform: translate(-50%, -50%);
      position: absolute
    }

    .card-rare[p0] {
      width: 26%;
      top: 2.5%;
      left: 16%;
      position: absolute
    }

    .card-gakunen[p0] {
      width: 12%;
      top: 0;
      right: 3%;
      position: absolute
    }

    .card-kaika-state[p0] {
      width: 22%;
      top: 15%;
      left: 3%;
      position: absolute
    }

    .card-skill-bg[p0] {
      width: 85%;
      top: 80%;
      left: 4%;
      position: absolute
    }

    .card-info-footer[p0] {
      width: 100%;
      bottom: 0;
      left: 0;
      color: #fff;
      font-family: SEGA_Humming;
      font-size: 3cqw;
      background: rgba(0, 0, 0, .5);
      position: absolute
    }

    .card-star-container[p0] {
      width: 70%;
      height: 4.7%;
      top: 75%;
      left: 21%;
      position: absolute
    }

    .card-star-container[p0] .card-star[p0] {
      text-align: left;
      height: 100%;
      margin: 0 -1.2%;
      float: left
    }

    .card-qr-code-container[p0] {
      width: 20%;
      top: 80.5%;
      right: 5%;
      background: white;
      position: absolute
    }

    .card-qr-code[p0] {
      width: 100%
    }

    .card-max-atk[p0] {
      width: 10%
    }

    .card-max-atk-title[p0] {
      width: 14%;
      top: 70%;
      left: 6%;
      position: absolute
    }

    .card-max-atk-value-container[p0] {
      width: 25%;
      height: 6.5%;
      top: 73.5%;
      left: 0%;
      position: absolute;
      text-align: center
    }

    .card-max-atk-value-number[p0] {
      vertical-align: top;
      height: 100%;
      margin: 0 -8.2%
    }

    .card-name[p0] {
      color: #fff;
      width: 100%;
      height: 10%;
      text-align: right;
      top: 67%;
      right: 7%;
      position: absolute;
      font-family: SEGA_Humming;
      rotate: -6deg
    }

    .card-name[p0] .card-name-shadow[p0] {
      position: absolute;
      top: calc(50% + .3cqw);
      right: -.3cqw;
      color: #2592c1;
      -webkit-text-stroke: .9cqw #2592C1;
      transform: translateY(-50%)
    }

    .card-name[p0] .card-name-shadow[p0] .card-name-text[p0] {
      top: calc(50% + .2cqw);
      right: -.2cqw;
      -webkit-text-stroke: .9cqw #2592C1
    }

    .card-name[p0] .card-name-shadow[p0] .card-name-chara[p0] {
      top: calc(50% + .5cqw);
      right: -.5cqw;
      -webkit-text-stroke: 1.2cqw #2592C1
    }

    .card-name[p0] .card-name-text[p0] {
      position: absolute;
      top: 50%;
      right: 0;
      transform: translateY(-50%)
    }

    .card-name[p0] .card-name-nick[p0] {
      font-size: 2.8cqw
    }

    .card-name[p0] .card-name-chara[p0] {
      font-size: 5.4cqw
    }

    .card-backdrop[p0] {
      position: fixed;
      width: 100%;
      height: 100%;
      background: black;
      opacity: .8;
      top: 0;
      left: 0;
      z-index: 1099;
      transition: opacity 1s linear;
      visibility: visible
    }

    .card-backdrop-hidden[p0] {
      visibility: hidden;
      opacity: 0;
      transition: opacity 1s linear, visibility 0s linear 1s
    }

    .card-context[p0] {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, .5)
    }

    .card-context-hidden[p0] {
      visibility: hidden;
      opacity: 0;
      transition: opacity .3s linear, visibility 0s linear .3s
    }

    .card-back[p0] {
      position: absolute;
      inset: 0;
      width: 100%;
      aspect-ratio: .730038022813688;
      border-radius: 3%;
      background-size: cover;
      transform: rotateY(180deg);
      backface-visibility: hidden;
      background-position: center
    }

    .card-level[p0],
    .card-details-table[p0] td[p0] {
      width: 50%
    }
  </style>
</head>

<body class="overflow-hidden">
  <app-root _nghost-ng-p1="" ng-version="16.2.12">
    <div p1="" class="app-container">
      <div p1="" class="flex-grow-1">
        <div p1="" class="position-relative">
          <div p1="" class="d-lg-grid container-xxl"
            style="grid-template-areas: 'sidebar main'; grid-template-columns: auto 1fr;">
            <main p1="" class="order-1 ms-0 ms-lg-3 me-lg-2" style="grid-area: main; margin-top: 0rem;">

              <!-- Card container -->
              <app-ongeki-card _nghost-ng-p0="" class="p3 STARR">
                    <!-- Main card container -->
                    <div p0="" class="card-container user-select-none p3 STARR">
                      <!-- Character background image 卡片图片 -->
                      <div p0="" class="card-chara p3"
                        style="background-position-x: 0%; background-image: url(&quot;./UI_Card_Chara_199008_P.png&quot;);"></div>
                      <!-- Card main attributes container 主要属性 -->
                      <div p0="" class="position-absolute w-100 h-100 p3 STARR" MAINATTRIBUTE>
                        <!-- Element attribute -->
                        <div p0="" class="p3"><img p0="" class="card-attribute p3 STARR"
                            src="./CardPreview/UI_Card_Attribute_01_Bule.webp">
                        </div>
                        <!-- Rarity indicator -->
                        <div p0="" class="p3" RARITY><img p0="" class="card-rare p3 STARR"
                            src="./CardPreview/UI_Card_Rare_03_SSR.webp"></div>
                        <!-- Grade level -->
                        <div p0="" class="p3" GRADE><img p0="" class="card-gakunen p3 STARR"
                            src="./CardPreview/UI_Card_Grade_00002.webp">
                        </div>
                        <!-- Card name section -->
                        <div p0="" class="card-name p3">
                          <!-- Name shadow effect -->
                          <div p0="" class="card-name-shadow p3">
                            <div p0="" class="card-name-nick p3"> Arcaea
                            </div>
                            <div p0="" class="card-name-chara p3"> 彩夢
                            </div>
                          </div>
                          <!-- Name text -->
                          <div p0="" class="card-name-text p3">
                            <div p0="" class="card-name-nick card-text-shadow p3"> Arcaea </div>
                            <div p0="" class="card-name-chara card-text-shadow p3"> 彩夢 </div>
                          </div>
                        </div>
                      </div>
                      <!-- Card Sub attributes container 其他属性 -->
                      <div p0="" SUBATTRIBUTE>
                        <!-- Card serial number footer -->
                        <div p0="" class="card-info-footer p3" SERIAL><span p0="" class="p3">
                            　　11010119530615199005 </span><span p0="" class="p3 STARR">
                            [O.N.G.E.K.I.]2.05-0005 </span></div>
                        <div p0="" class="p3 STARR" ATTRIBUTE>
                          <!-- Evolution state mark -->
                          <img p0="" draggable="false" class="card-kaika-state p3 STARR"
                            src="/../assets/images/ui/UI_CMN_PrintMark_02_tyoukaika.webp">
                        </div>
                        <!-- Skill section -->
                        <div p0="" class="p3 STARR">
                          <div p0="" class="p3" SKILL><img p0="" draggable="false"
                              class="card-skill-bg p3 STARR" src="./CardPreview/UI_Card_Skill_00_Attack.webp">
                          </div>
                        </div>
                        <!-- Star rating -->
                        <div p0="" class="card-star-container p3" STAR><img p0=""
                            class="card-star p3 STARR" src="/../assets/images/ui/UI_Card_star_00.webp"><img p0=""
                            class="card-star p3 STARR" src="/../assets/images/ui/UI_Card_star_00.webp"><img p0=""
                            class="card-star p3 STARR" src="/../assets/images/ui/UI_Card_star_00.webp"><img p0=""
                            class="card-star p3 STARR" src="/../assets/images/ui/UI_Card_star_00.webp"><img p0=""
                            class="card-star p3 STARR" src="/../assets/images/ui/UI_Card_star_00.webp"></div>
                        <!-- Attack value section -->
                        <img p0="" draggable="false" class="card-max-atk-title p3"
                          src="/../assets/images/ui/UI_Card_max_00.webp">
                        <div p0="" class="card-max-atk-value-container p3 STARR"><img p0=""
                            class="card-max-atk-value-number p3 STARR" src="./CardPreview/3.webp"><img p0=""
                            class="card-max-atk-value-number p3 STARR" src="./CardPreview/3.webp"><img p0=""
                            class="card-max-atk-value-number p3" src="./CardPreview/1.webp"></div>
                      </div>
                    </div>
              </div>
          <!-- Bottom margin -->
          <div p0="" class="mb-2 p3"></div>
          </app-ongeki-card>
          </main>
        </div>
      </div>
    </div>
  </app-root>

</body>

</html>`;
    let useLocalImg = false;
    let localImgDataUrl = "";
    // 获取所有输入元素
    const inputs = {
        chara: document.getElementById('chara'),
        offsetX: document.getElementById('offsetX'),
        offsetXValue: document.getElementById('offsetXValue'),
        name: document.getElementById('name'),
        nick: document.getElementById('nick'),
        attribute: document.getElementById('attribute'),
        rarity: document.getElementById('rarity'),
        grade: document.getElementById('grade'),
        serial: document.getElementById('serial'),
        skill: document.getElementById('skill'),
        stars: document.getElementById('stars'),
        atk: document.getElementById('atk'),
        version: document.getElementById('version')
    };
    // 获取按钮和文件输入元素
        const charaInput = document.getElementById('chara');
        const uploadLocalBtn = document.getElementById('uploadLocalBtn');
        const toggleImgSourceBtn = document.getElementById('toggleImgSourceBtn');
        const localImgInput = document.getElementById('localImgInput');

    // Token验证函数
    async function verifyToken() {
        const token = tokenInput.value.trim();
        if (!token) {
            showAuthStatus('请输入Token', 'error');
            return;
        }

        verifyBtn.disabled = true;
        verifyBtn.textContent = '验证中...';

        try {
            // 向API发送验证请求
            const response = await fetch('https://api.riv62hjux.nyat.app:43419/api/v1/nkey/validate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    nkey: token,
                    app_id: 'CardPreview'
                })
            });

            const result = await response.json();

            if (response.ok && result.code === 200 && result.data.valid) {
                isAuthenticated = true;
                showAuthStatus(`token正确✅您可以使用渲染功能了`, 'success');
                enableImageInputs();
            } else {
                isAuthenticated = false;
                showAuthStatus(result.message || 'Token验证失败', 'error');
                disableImageInputs();
            }
        } catch (error) {
            isAuthenticated = false;
            showAuthStatus('网络错误，请检查服务器连接', 'error');
            disableImageInputs();
        }

        verifyBtn.disabled = false;
        verifyBtn.textContent = '验证';
    }

    // 显示验证状态
    function showAuthStatus(message, type) {
        authStatus.textContent = message;
        authStatus.className = `auth-status ${type}`;
        authStatus.style.display = 'block';
    }

    // 启用图片输入相关控件
    function enableImageInputs() {
        charaInput.disabled = false;
        uploadLocalBtn.disabled = false;
        toggleImgSourceBtn.disabled = false;
    }

    // 禁用图片输入相关控件
    function disableImageInputs() {
        charaInput.disabled = true;
        uploadLocalBtn.disabled = true;
        toggleImgSourceBtn.disabled = true;
    }

    // 页面加载时自动检查URL中的ntoken参数
    function autoVerifyFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const nkey = urlParams.get('ntoken');
        
        if (nkey) {
            // 填入token输入框
            tokenInput.value = nkey;
            // 自动触发验证
            verifyToken();
        }
    }

    // 绑定token验证事件
    verifyBtn.addEventListener('click', verifyToken);
    tokenInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            verifyToken();
        }
    });


    // 更新预览
    function updatePreview() {
        let code = template;

        // 替换角色图片
        let charaUrl = useLocalImg && localImgDataUrl ? localImgDataUrl : charaInput.value;
        code = code.replace(
            /background-image: url\(&quot;(.*?)&quot;\)/,
            `background-image: url(&quot;${charaUrl}&quot;)`
        );

        // 替换背景偏移
        code = code.replace(
            /background-position-x:\s*[^;]*;/,
            `background-position-x: ${parseInt(inputs.offsetX.value)}%;`
        );

        // 替换名字和昵称
        code = code.replace(
            /class="card-name-nick p3">([^<]*?)<\/div>/,
            `class="card-name-nick p3">${inputs.nick.value}</div>`
        );

        code = code.replace(
            /class="card-name-nick card-text-shadow p3">([^<]*?)<\/div>/,
            `class="card-name-nick card-text-shadow p3">${inputs.nick.value}</div>`
        );

        code = code.replace(
            /class="card-name-chara p3">([^<]*?)<\/div>/,
            `class="card-name-chara p3">${inputs.name.value}</div>`
        );

        code = code.replace(
            /class="card-name-chara card-text-shadow p3">([^<]*?)<\/div>/,
            `class="card-name-chara card-text-shadow p3">${inputs.name.value}</div>`
        );

        // 替换主要属性
        code = code.replace(
            'src="./CardPreview/UI_Card_Attribute_01_Bule.webp"',
            `src="${inputs.attribute.value}"`
        );

        // 替换稀有度
        code = code.replace(
            'src="./CardPreview/UI_Card_Rare_03_SSR.webp"',
            `src="${inputs.rarity.value}"`
        );

        // 替换年级
        code = code.replace(
            'src="./CardPreview/UI_Card_Grade_00002.webp"',
            `src="${inputs.grade.value}"`
        );

        // 更新序列号
        code = code.replace(
            />[\s　]*?11010119530615199005\s*</,
            `>　　${inputs.serial.value} <`
        );

        // 更新版本号
        code = code.replace(
            /\[O\.N\.G\.E\.K\.I\.\](.*?)<\/span>/,
            `${inputs.version.value}</span>`
        );

        // 更新技能背景
        code = code.replace(
            'src="./CardPreview/UI_Card_Skill_00_Attack.webp"',
            `src="${inputs.skill.value}"`
        );

        // 更新星级
        const stars = parseInt(inputs.stars.value);
        const starImg = '<img p0="" class="card-star p3 STARR" src="/../assets/images/ui/UI_Card_star_00.webp">';
        code = code.replace(
            /(<div p0="" class="card-star-container p3" STAR>)(.*?)(<\/div>)/s,
            `$1${starImg.repeat(stars)}$3`
        );

        // 更新攻击力数值
        const atk = inputs.atk.value.padStart(3, '0');
        code = code.replace(
            /(<div p0="" class="card-max-atk-value-container p3 STARR">)(.*?)(<\/div>)/s,
            `$1${Array.from(atk).map(n =>
                `<img p0="" class="card-max-atk-value-number p3 STARR" src="/../assets/images/ui/${n}.webp">`
            ).join('')}$3`
        );
        
        // 隐藏主要或次要属性 
        if (document.getElementById('toggleMainAttributes').checked) {
            code = code.replace(/<div p0="" class="position-absolute w-100 h-100 p3 STARR" MAINATTRIBUTE>/g, '<div p0="" class="position-absolute w-100 h-100 p3 STARR" MAINATTRIBUTE style="display: none;">');
        }
        if (document.getElementById('toggleSubAttributes').checked) {
            code = code.replace(/<div p0="" SUBATTRIBUTE>/g, '<div p0="" SUBATTRIBUTE style="display: none;">');
        }

        // 更新显示
        document.getElementById('livePreview').innerHTML = code;
    }

    // 为所有输入添加事件监听
    Object.values(inputs).forEach(input => {
        input.addEventListener('input', () => {
            // 同步滑块和输入框的值
            if (input === inputs.offsetX) {
                inputs.offsetXValue.value = inputs.offsetX.value;
            } else if (input === inputs.offsetXValue) {
                inputs.offsetX.value = inputs.offsetXValue.value;
            }
            updatePreview();
        });
    });

    // 初始化
    updatePreview();
    disableImageInputs(); // 页面加载时默认禁用图片相关控件
    
    // 页面加载时调用自动验证函数
    document.addEventListener('DOMContentLoaded', autoVerifyFromURL);
    autoVerifyFromURL(); // 检查URL中的ntoken参数并自动验证
    
    document.getElementById('toggleMainAttributes').addEventListener('change', updatePreview);
    document.getElementById('toggleSubAttributes').addEventListener('change', updatePreview);

    // 下载按钮事件处理
    document.getElementById('downloadBtn').addEventListener('click', function () {
        // 使用setTimeout确保DOM更新
        setTimeout(() => {
            const cardElement = document.querySelector('#livePreview .card-container');
            if (!cardElement) {
                alert('未找到卡片元素，请确保预览已加载');
                return;
            }
            html2canvas(cardElement, { scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'UI_Card_' + inputs.serial.value + '.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }, 100);
    });

    // 新增：本地/远程图片切换逻辑


// 选择本地图片
uploadLocalBtn.addEventListener('click', () => {
    localImgInput.click();
});

localImgInput.addEventListener('change', function () {
    const file = this.files[0];
    if (file && (file.type === "image/png"|| file.type === "image/jpeg" || file.type === "image/jpg")) {
        const reader = new FileReader();
        reader.onload = function (e) {
            localImgDataUrl = e.target.result;
            useLocalImg = true;
            updatePreview();
        };
        reader.readAsDataURL(file);
    } else {
        alert("请尽量选择PNG格式图片");
    }
});

// 切换本地/远程
toggleImgSourceBtn.addEventListener('click', () => {
    useLocalImg = !useLocalImg;
    updatePreview();
    toggleImgSourceBtn.textContent = useLocalImg ? "切换为远程" : "切换为本地";
});

</script>
</body>
</html>